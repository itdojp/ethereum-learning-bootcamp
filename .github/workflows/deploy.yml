name: deploy

on:
  workflow_dispatch:
    inputs:
      network:
        description: "target network"
        required: true
        type: choice
        default: mainnet
        options: [mainnet, optimism]
      contract:
        description: "contract name"
        required: true
        default: MyToken
      args:
        description: "constructor args separated by space"
        required: false
        default: "1000000000000000000000000"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - name: Select RPC by network
        id: select
        run: |
          if [ "${{ inputs.network }}" = "mainnet" ]; then
            echo "rpc=${{ secrets.PRODUCTION_MAINNET_RPC_URL }}" >> "$GITHUB_OUTPUT"
            echo "scan_key=${{ secrets.ETHERSCAN_API_KEY }}" >> "$GITHUB_OUTPUT"
          else
            echo "rpc=${{ secrets.PRODUCTION_OPTIMISM_RPC_URL }}" >> "$GITHUB_OUTPUT"
            echo "scan_key=${{ secrets.OPTIMISTIC_ETHERSCAN_API_KEY }}" >> "$GITHUB_OUTPUT"
          fi
      - name: Compile
        run: npx hardhat compile
      - name: Deploy
        env:
          PRIVATE_KEY: ${{ secrets.PRODUCTION_PRIVATE_KEY }}
          RPC_URL: ${{ steps.select.outputs.rpc }}
          ETHERSCAN_API_KEY: ${{ steps.select.outputs.scan_key }}
        run: |
          echo "network=${{ inputs.network }}"
          CONTRACT=${{ inputs.contract }} ARGS="${{ inputs.args }}" \
          npx hardhat run scripts/deploy-generic.ts --network ${{ inputs.network }}
      - name: Verify hint
        env:
          ETHERSCAN_API_KEY: ${{ steps.select.outputs.scan_key }}
        run: |
          echo "Use npx hardhat verify --network ${{ inputs.network }} <address> <constructor args>"
          echo "Address can be passed via workflow outputs/artifacts in a follow-up enhancement."
